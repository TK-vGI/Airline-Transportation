# Stage 5/6: Top Routes by Duration for Each Company
## Description
In this stage, your goal as a novice data analyst is to pinpoint the top two routes with  
the lengthiest average flight durations for every airline company. This involves analyzing flight data to determine  
the average duration between departure and arrival cities. The query will organize the data by company, departure city,  
and arrival city, calculating the average duration for each route. Finally, it ranks the routes by duration,  
selecting only the top two routes for each company.

## Objectives
- Identify the `company_name` from the `Airline_company` table and their corresponding `town_from` as `departure_city`,  
  `town_to` as `arrival_city`, and average flight durations in **minutes** for routes from the `Trip` table as `avg_flight_duration`.
- Output only the **top 2** airline companies as `company_name` based on the `avg_flight_duration`.
- Utilize the `JOIN` function to combine multiple tables correctly, and it is **recommended** to use the `WITH(CTE)` or  
  `subqueries` with `ROW_NUMBER()` function to correctly rank the airline companies.
- The column order is essential.

_Hint: Use the query from Stage 3 for the calculation of `avg_flight_duration`._

### ChatGPT prompts that help to write the query
- Imagine you have data spread across multiple tables containing information about airline companies, routes,  
  and flight durations. How would you formulate an SQL query to extract relevant information such as company names,  
  departure cities, arrival cities, and average flight durations for each route?
- Now, assuming you've extracted the necessary information, how would you utilize SQL to rank the airline companies  
  based on average flight durations for their routes? Consider using techniques like window functions or  
  subqueries to achieve this.
- In addition to ranking airline companies, how would you formulate an SQL query to filter the results and output only  
  the top two airline companies based on average flight durations for their routes?

Take a look at the following database structure:

![Explanation of the database](./STAGE1_IMG1.png)

### Explanation of the database
The **`Airline Transportation Database`** encompasses four main tables: `Airline_Company`, `Trip`, `Passenger`, and `Pass_in_trip`.  
It facilitates the management of airline operations, storing critical information about airline companies, flights,  
passengers, and trip details.

In-depth details of each table are as follows:

`Airline_company`**: Serves as a repository for airline company information, providing a unique identifier for      
each company along with their respective names.
- `ID_comp`: Primary key representing the unique identifier for each airline company.
- `company_name`: Stores the name of the airline company, enabling identification and association with flight operations.

`Trip`**: Contains detailed information about each flight trip.
- `trip_no`: Primary key serving as a unique identifier for each flight trip.
- `ID_comp`: Foreign key referencing the ID_comp in the Airline_Company table, establishing a relationship between flights and airline companies.
- `plane_type`: Records the type of aircraft used for the flight.
- `town_from`: Indicates the departure city of the flight.
- `town_to`: Specifies the arrival city of the flight.
- `time_out`: Stores the departure time of the flight.
- `time_in`: Records the arrival time of the flight.

`Passenger`**: Maintains records of individual passengers.
- `ID_psg`: Primary key representing the unique identifier for each passenger.
- `passenger_name`: Stores the name of the passenger, facilitating passenger identification and management.

`Pass_in_trip`**: Serves as a bridge between passengers and trip details.
- `trip_no`: Foreign key referencing the trip_no in the Trip table, establishing a relationship between passengers and flights.
- `trip_date`: Records the date of the trip, allowing for chronological organization of passenger-trip associations.
- `ID_psg`: Foreign key referencing the ID_psg in the Passenger table, associating passengers with specific trips.
- `seat_number`: Indicates the seat number occupied by the passenger during the trip, providing seating information   
  for passenger tracking and flight organization.

### Additional information and rules to consider:
- flights operate daily, and the flight duration of any flight is less than a day; `town_from` <> `town_to`.
- time and date in the `time_out` and `time_in` are taken into account relative to one-time zone.
- `time_out` and `time_in` times are indicated accurate to the minute.
- `passenger_name` may have namesakes (same name field values).
- the `seat_number` in the cabin is a number with a letter; the number determines the number of the row  
  in the range from 01 to 99, and the letter (a – d) – the place in the row from left to right in alphabetical order.

** _Table names are case-sensitive._

Click on the [Database.sql](Database.sql) to download the SQL query for creating the database.

## Example

_Airline_company Table Example:_

| ID_comp | company_name      |
|---------|-------------------|
| 1       | Delta Airlines    |
| 2       | American Airlines |

_Trip Table Example:_

| trip_no | ID_comp | plane_type  | town_from | town_to     | time_out            | time_in             |
|---------|---------|-------------|-----------|-------------|---------------------|---------------------|
| 1       | 2       | Boeing 737  | Chicago   | Miami       | 2024-02-23 08:00:00 | 2024-02-23 18:45:00 |
| 2       | 2       | Airbus A320 | New York  | Boston      | 2024-02-25 03:30:00 | 2024-02-25 15:20:00 |
| 3       | 2       | Boeing 777  | New York  | Los Angeles | 2024-02-24 23:00:00 | 2024-02-25 08:00:00 |
| 4       | 1       | Airbus A330 | Denver    | Chicago     | 2024-02-24 16:40:00 | 2024-02-24 23:30:00 |

From the data above, we can see that for `company_name`: **American Airlines** (`ID_comp`: **2**), three routes are **Chicago - Miami**,  
**New York - Boston**, and **New York - Los Angeles**. The `avg_flight_duration` for these routes are **645 minutes**, **710 minutes**,  
and **540 minutes** respectively. The top two longest `avg_flight_duration` are **710** and **645 minutes**, corresponding  
to the routes **New York - Boston** and **Chicago - Miami**.

The resulting output table shows each `company_name` alongside its corresponding `departure_city`, `arrival_city`,  
and `avg_flight_duration` for the top 2 `avg_flight_duration`:

| aircraft_type     | departure_city | arrival_city | avg_flight_duration |
|-------------------|----------------|--------------|---------------------|
| American Airlines | New York       | Boston       | 710                 |
| American Airlines | Chicago        | Miami        | 645                 |
| Delta Airlines    | Denver         | Chicago      | 410                 |

_From the output above, it can be seen that the order of the columns is `company_name` -> `departure_city` -> `arrival_city` -> `avg_flight_duration`_

## Query template:
```markdown
WITH RouteDuration AS (
    SELECT
        ac.company_name,
        t.town_from AS departure_city,
        t.town_to AS arrival_city, ...;
```